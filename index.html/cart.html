<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cart - Prakash Shoe Center</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="header">
    <div class="left"><a class="logo" href="index.html">Prakash Shoe Center</a></div>
    <nav>
      <a href="shoe.html">Shoes</a><a href="cart.html" class="cart-badge">Cart ðŸ›’ (<span data-cart-count>0</span>)</a>
    </nav>
  </header>

  <main class="container">
    <div class="card">
      <h2>Your Cart</h2>
      <div id="cart-area" style="margin-top:12px"></div>
      <div id="cart-summary" style="margin-top:12px"></div>

      <div style="margin-top:16px">
        <label>Contact number</label>
        <input id="contact" type="text" placeholder="e.g. +977 98XXXXXXXX" />
        <label style="margin-top:8px">Delivery address</label>
        <textarea id="address" rows="3"></textarea>

        <div class="checkout-row" style="margin-top:12px">
          <div class="text-muted">Payment: Cash on delivery</div>
          <div style="flex:0 0 240px">
            <button id="place-order" class="btn btn-primary" style="width:100%">Place Order (COD)</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:18px">
      <h3>Pending Orders</h3>
      <div id="pending-list" style="margin-top:12px"></div>
    </div>
  </main>

  <div id="toast" class="toast"></div>

  <!-- optional EmailJS -->
  <!-- Include EmailJS lib if you want email notifications -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    // Initialize EmailJS if you plan to use it:
    // emailjs.init("YOUR_EMAILJS_USER_ID");
    // Later we call emailjs.send('service_x','template_y', params)
  </script>

  <script src="store-data.js"></script>
  <script>
  (function(){
    const toast = document.getElementById('toast');
    function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'),2600); }

    function getCart(){ return JSON.parse(localStorage.getItem('cart')) || []; }
    function saveCart(c){ localStorage.setItem('cart', JSON.stringify(c)); renderCart(); updateCartBadge(); }

    function updateCartBadge(){
      const count = getCart().reduce((s,i)=> s + (i.quantity||0),0);
      document.querySelectorAll('[data-cart-count]').forEach(e=> e.textContent = count);
    }

    function renderCart(){
      const cart = getCart();
      const area = document.getElementById('cart-area');
      if(!cart.length){ area.innerHTML = '<p class="text-muted">Your cart is empty.</p>'; document.getElementById('cart-summary').innerHTML=''; return; }
      let total = 0;
      let html = '<table class="cart-table"><thead><tr><th>Product</th><th>Details</th><th>Qty</th><th>Subtotal</th><th></th></tr></thead><tbody>';
      cart.forEach((it, idx) => {
        const subtotal = (it.price||0) * (it.quantity||1);
        total += subtotal;
        html += `<tr>
          <td><img src="${it.image || window.__STORE_FALLBACK_IMAGE}" alt="${it.name}"></td>
          <td><strong>${it.name}</strong><br/><span class="text-muted">${it.size? 'Size: '+it.size : ''}${it.color? ' | '+it.color : ''}</span><br/>NPR ${Number(it.price).toFixed(0)}</td>
          <td>
            <div class="qty">
              <button onclick="changeQty(${idx}, -1)">-</button>
              <span class="qty-value">${it.quantity}</span>
              <button onclick="changeQty(${idx}, 1)">+</button>
            </div>
          </td>
          <td>NPR ${Number(subtotal).toFixed(0)}</td>
          <td><button class="btn-danger" onclick="removeItem(${idx})">Remove</button></td>
        </tr>`;
      });
      html += '</tbody></table>';
      area.innerHTML = html;
      document.getElementById('cart-summary').innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px"><div class="text-muted">Total</div><div style="font-weight:800">NPR ${Number(total).toFixed(0)}</div></div>`;
    }

    window.changeQty = function(idx, delta){
      const cart = getCart();
      if(!cart[idx]) return;
      cart[idx].quantity += delta;
      if(cart[idx].quantity <= 0) cart.splice(idx,1);
      saveCart(cart);
    };

    window.removeItem = function(idx){
      const cart = getCart();
      cart.splice(idx,1);
      saveCart(cart);
      showToast('Removed from cart');
    };

    function getPending(){ return JSON.parse(localStorage.getItem('pendingOrders')) || []; }
    function savePending(arr){ localStorage.setItem('pendingOrders', JSON.stringify(arr)); renderPending(); }

    function renderPending(){
      const list = getPending();
      const out = document.getElementById('pending-list');
      if(!list.length){ out.innerHTML = '<p class="text-muted">No pending orders.</p>'; return; }
      out.innerHTML = '';
      list.forEach(o=>{
        const div = document.createElement('div');
        div.className = 'pending-item';
        div.innerHTML = `<div style="display:flex;justify-content:space-between"><div>
            <div><strong>Order:</strong> ${o.id}</div>
            <div class="text-muted">Placed: ${o.date}</div>
            <div><strong>Contact:</strong> ${o.contact}</div>
            <div><strong>Address:</strong> ${o.address}</div>
          </div>
          <div style="text-align:right">
            <div><strong>Status:</strong> ${o.status}</div>
            <div style="margin-top:10px"><button class="btn-ghost" onclick="viewOrder('${o.id}')">View</button> <button class="btn-danger" onclick="cancelOrder('${o.id}')">Cancel</button></div>
          </div></div>`;
        const ul = document.createElement('ul');
        ul.style.marginTop = '10px';
        o.items.forEach(i => { const li=document.createElement('li'); li.innerHTML = `${i.name} (${i.size||'N/A'}, ${i.color||'N/A'}) - x${i.quantity} - NPR ${Number(i.price).toFixed(0)}`; ul.appendChild(li); });
        div.appendChild(ul);
        out.appendChild(div);
      });
    }

    window.viewOrder = function(id){
      const o = getPending().find(p=>p.id===id);
      if(!o) return alert('Not found');
      alert('Order '+id+'\\nStatus: '+o.status);
    };

    window.cancelOrder = function(id){
      if(!confirm('Cancel this order?')) return;
      let pending = getPending();
      pending = pending.filter(p=>p.id!==id);
      savePending(pending);
      showToast('Order cancelled');
    };

    // Place order â€” saves pending locally and optionally sends email via EmailJS
    document.getElementById('place-order').addEventListener('click', async ()=>{
      const contact = document.getElementById('contact').value.trim();
      const address = document.getElementById('address').value.trim();
      const items = getCart();
      if(!contact || !address){ alert('Enter contact and address'); return; }
      if(!items.length){ alert('Cart empty'); return; }

      const order = {
        id: 'ORD-'+Date.now(),
        items,
        contact, address,
        status: 'Pending',
        date: new Date().toLocaleString()
      };

      // Save pending locally
      const pending = getPending();
      pending.push(order);
      savePending(pending);

      // Send confirmation email via EmailJS (optional)
      try {
        if(typeof emailjs !== 'undefined' && emailjs.send){
          // Replace service/template IDs with your EmailJS values
          const templateParams = {
            order_id: order.id,
            contact: order.contact,
            address: order.address,
            items: order.items.map(i=>`${i.name} x${i.quantity}`).join(', '),
            total: order.items.reduce((s,i)=>s + (i.price||0)* (i.quantity||1),0)
          };
          // Uncomment and replace your service/template/user IDs
          // await emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', templateParams);
        }
      } catch(e){
        console.warn('EmailJS failed', e);
      }

      // Clear cart
      localStorage.removeItem('cart');
      renderCart();
      updateCartBadge();
      document.getElementById('contact').value=''; document.getElementById('address').value='';
      showToast('Order placed â€” status Pending');
    });

    // init
    renderCart(); renderPending(); updateCartBadge();
  })();
  </script>
</body>
</html>
