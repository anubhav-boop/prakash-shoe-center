<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cart - Prakash Shoe Center</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="header">
    <div class="left"><div class="logo">Prakash Shoe Center</div></div>
    <nav>
      <a href="index.html">Home</a>
      <a href="shoe.html">Shoes</a>
      <a href="cart.html" class="cart-badge">Cart ðŸ›’ (<span data-cart-count>0</span>)</a>
    </nav>
  </header>

  <main class="container">
    <div class="card">
      <h2>Your Cart</h2>
      <div id="cart-area"></div>
      <div id="cart-summary"></div>

      <div style="margin-top:16px">
        <label>Contact number</label>
        <input id="contact" type="text" placeholder="e.g. +977 98XXXXXXXX" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e6e9ef" />
        <label style="margin-top:8px">Delivery address</label>
        <textarea id="address" rows="3" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e6e9ef"></textarea>

        <div class="checkout-row">
          <div class="text-muted">Payment: Cash on delivery</div>
          <div style="flex:0 0 260px">
            <button id="place-order" class="btn btn-primary" style="width:100%">Place Order (COD)</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:18px">
      <h3>Pending Orders</h3>
      <div id="pending-list"></div>
    </div>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script src="store-data.js"></script>
  <script>
    // Minimal safe Firestore integration if firebase app exists
    const hasFirebase = typeof firebase !== 'undefined' || false;

    function getCart(){ return JSON.parse(localStorage.getItem('cart')) || []; }
    function saveCart(c){ localStorage.setItem('cart', JSON.stringify(c)); updateCartCount(); renderCart(); }
    function updateCartCount(){
      const cart = getCart(); const count = cart.reduce((s,i)=> s + (i.quantity||0), 0);
      document.querySelectorAll('[data-cart-count]').forEach(el=> el.textContent = count);
    }

    function currency(n){ return Number(n).toFixed(0); }

    function renderCart(){
      const cart = getCart();
      const area = document.getElementById('cart-area');
      if(!cart.length){ area.innerHTML = '<p class="text-muted">Your cart is empty.</p>'; document.getElementById('cart-summary').innerHTML=''; return; }

      let html = '<table class="cart-table"><thead><tr><th>Item</th><th>Details</th><th>Qty</th><th>Subtotal</th><th></th></tr></thead><tbody>';
      let total = 0;
      cart.forEach((it, idx) => {
        const subtotal = (it.price || 0) * (it.quantity || 1);
        total += subtotal;
        html += `<tr>
          <td><img src="${it.image || window.__STORE_FALLBACK_IMAGE}" alt="${it.name}"></td>
          <td><strong>${it.name}</strong><br/><span class="text-muted">${it.size ? 'Size: '+it.size+' ' : ''}${it.color? ' | '+it.color : ''}</span><br/>NPR ${currency(it.price)}</td>
          <td>
            <div class="qty">
              <button onclick="changeQty(${idx}, -1)">-</button>
              <span class="qty-value">${it.quantity}</span>
              <button onclick="changeQty(${idx}, 1)">+</button>
            </div>
          </td>
          <td>NPR ${currency(subtotal)}</td>
          <td><button class="btn-danger" onclick="removeItem(${idx})">Remove</button></td>
        </tr>`;
      });
      html += '</tbody></table>';
      area.innerHTML = html;

      document.getElementById('cart-summary').innerHTML = `<div class="card" style="margin-top:12px"><div style="display:flex;justify-content:space-between"><div class="text-muted">Total</div><div style="font-weight:800">NPR ${currency(total)}</div></div></div>`;
    }

    window.changeQty = function(idx,delta){
      const cart = getCart();
      if(!cart[idx]) return;
      cart[idx].quantity += delta;
      if(cart[idx].quantity <= 0) cart.splice(idx,1);
      saveCart(cart);
    };

    window.removeItem = function(idx){
      const cart = getCart();
      if(!cart[idx]) return;
      cart.splice(idx,1);
      saveCart(cart);
      showToast('Item removed');
    };

    // Pending orders stored locally
    function getPending(){ return JSON.parse(localStorage.getItem('pendingOrders')) || []; }
    function savePending(p){ localStorage.setItem('pendingOrders', JSON.stringify(p)); renderPending(); }

    function renderPending(){
      const list = getPending();
      const el = document.getElementById('pending-list');
      if(!list.length){ el.innerHTML = '<p class="text-muted">No pending orders.</p>'; return; }
      el.innerHTML = '';
      list.forEach(o=>{
        const div = document.createElement('div');
        div.className = 'pending-item';
        div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div>
            <div><strong>Order ID:</strong> ${o.id}</div>
            <div class="text-muted">Placed: ${o.date}</div>
            <div><strong>Contact:</strong> ${o.contact}</div>
            <div><strong>Address:</strong> ${o.address}</div>
          </div>
          <div>
            <div style="text-align:right"><strong>Status:</strong> ${o.status}</div>
            <div style="margin-top:10px"><button class="btn btn-ghost" onclick="viewOrder('${o.id}')">View</button> <button class="btn-danger" onclick="cancelOrder('${o.id}')">Cancel</button></div>
          </div>
        </div>`;
        const ul = document.createElement('ul');
        ul.style.marginTop='8px';
        o.items.forEach(i=>{
          const li=document.createElement('li');
          li.innerHTML = `${i.name} (${i.size||'N/A'}, ${i.color||'N/A'}) - x${i.quantity} - NPR ${currency(i.price)}`;
          ul.appendChild(li);
        });
        div.appendChild(ul);
        el.appendChild(div);
      });
    }

    window.viewOrder = function(id){ const o=getPending().find(p=>p.id==id); if(!o) return alert('Order not found'); alert('Order '+id+'\\nStatus: '+o.status); }

    window.cancelOrder = function(id){
      if(!confirm('Cancel this order?')) return;
      let pending = getPending();
      pending = pending.filter(p=>p.id!==id);
      savePending(pending);
      showToast('Order cancelled');
      // Optionally update Firestore status if configured...
    };

    function showToast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 2600);
    }

    // Place order
    document.getElementById('place-order').addEventListener('click', async ()=>{
      const contact = document.getElementById('contact').value.trim();
      const address = document.getElementById('address').value.trim();
      const cart = getCart();
      if(!contact || !address){ alert('Please enter contact and address'); return; }
      if(!cart.length){ alert('Cart is empty'); return; }

      const order = {
        id: 'ORD-'+Date.now(),
        items: cart,
        contact, address,
        status: 'Pending',
        date: new Date().toLocaleString()
      };

      // Save pending locally
      const pending = getPending();
      pending.push(order);
      savePending(pending);

      // Optionally: save to Firestore (if you configured firebase & firestore)
      try {
        if(window.firebaseApp && window.firebaseFirestoreAdd){
          await window.firebaseFirestoreAdd(order); // implemented optionally in firebase helper
        }
      } catch(e){
        console.warn('Firestore save failed:', e);
      }

      // clear cart
      localStorage.removeItem('cart');
      renderCart();
      updateCartCount();
      document.getElementById('contact').value=''; document.getElementById('address').value='';
      showToast('Order placed â€” status: Pending');
    });

    // init
    renderCart(); renderPending(); updateCartCount();
  </script>
</body>
</html>
